<html>

<p>In 2016, the state voted on a ballot measure to legalize marijuana. Marijuana legalization vote in an election precinct did not follow a simple partisan pattern, though was modestly correlated to the Democratic vote of share of a place in 2012, with an R<sup>2</sup> = 0.43. Many of the more affluent Boston suburbs where Trump did badly voted against marijuana legalization; while reverse was true for some areas that became more Republican. This simple map marks:</p>

<ul>
  <li>Blue; Clinton Won and voted for Marijuana</li>
  <li>Green; Clinton Won and voted against Marijuana</li>
  <li>Orange; Trump Won and voted for Marijuana</li>
  <li>Red; Trump Won and voted against Marijuana</li>
</ul>

<img src="weed_trump_map.png" width="600">

<p>Also a good example of why election maps can be misleading; the actual result was a narrow in but appears Blue + Orange is the vast majority of the state, especially if one knows the Boston and adjacent cities are in the blue region. Most of the Green aren’t areas that are particularly friendly Democrats (by Massachusetts standards) in “normal” election years. Probably also tended to be older; the Cape in particular has lots of older retirees. The map may also might get one the misleading result that since more Trump voting areas voting for marijuana legalization, Trump voters tended to vote for marijuana legalization. 
		
<p>Here's a scatter plot showing how weell different groupings voted. In the purple and dark brown precincts [referring to the scatter plot colors, not the colors in the above map], which were more Democratic in 2016, marijuana legalization didn't do particularly well. You can see the correlation was tighter in 2012.</p>

<p>

<style>
body {
  font: 11px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.dot {
  stroke: #000;
}

.tooltip {
  position: absolute;
  width: 200px;
  height: 28px;
  pointer-events: none;
}
</style>
<body>

<div id="option">
    <input name="updateButton" 
           type="button" 
           value="2016" 
           onclick="change2016()" />
</div>
<div id="option">
    <input name="updateButton" 
           type="button" 
           value="2012" 
           onclick="change2012()" />
</div>


<script src="https://d3js.org/d3.v3.min.js"></script>

<script>

var margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = 700 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;


newGraph()

function newGraph() {
  d3.select("svg").remove();
  updateData();
}

function change2016() {
	
var	x_plotvar = "rep_2016pres",
	y_plotvar = "legalweed";
d3.selectAll("circle").transition(12000).attr("cx", function(d){return d3.scale.linear().domain([0, 0.7]).range([0, width])(d[x_plotvar])+"px"}).attr("cy", function(d){return d3.scale.linear().domain([0.25, 0.9]).range([height, 0])(d.legalweed)+"px"})

}

function change2012() {
	
var x_plotvar = "rep_2012pres",
	y_plotvar = "legalweed";
d3.selectAll("circle").transition(12000).attr("cx", function(d){return d3.scale.linear().domain([0, 0.7]).range([0, width])(d[x_plotvar])+"px"}).attr("cy", function(d){return d3.scale.linear().domain([0.25, 0.9]).range([height, 0])(d[y_plotvar])+"px"})

}


function updateData() {


var    x_plotvar = "White_Education",
    y_plotvar = "rep_2016pres";



/* 
 * value accessor - returns the value to encode for a given data object.
 * scale - maps value to a visual display encoding, such as a pixel position.
 * map function - maps from data value to display value
 * axis - sets up axis
 */ 

var margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = 700 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

// setup x 
var xValue = function(d) { return d[x_plotvar];}, // data -> value
    xScale = d3.scale.linear().range([0, width]), // value -> display
    xMap = function(d) { return xScale(xValue(d));}, // data -> display
    xAxis = d3.svg.axis().scale(xScale).orient("bottom");

// setup y
var yValue = function(d) { return d[y_plotvar];}, // data -> value
    yScale = d3.scale.linear().range([height, 0]), // value -> display
    yMap = function(d) { return yScale(yValue(d));}, // data -> display
    yAxis = d3.svg.axis().scale(yScale).orient("left");

// setup fill color
var cValue = function(d) { return d.k_means_pca;},
    color = d3.scale.ordinal()
	  .domain([1,2,3,4,5,6,7,8])
	  .range([d3.rgb(255,0,0), d3.rgb(252,249,0) , d3.rgb(63,0,255),d3.rgb(0,204,0),d3.rgb(248,58,203),d3.rgb(0,207,255),d3.rgb(187,96,0),d3.rgb(255,161,0)]);

// add the graph canvas to the body of the webpage
var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// add the tooltip area to the webpage
var tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

// load data

d3.csv("elec_new.csv", function(error, data) {

  // change string (from CSV) into number format
 

  // don't want dots overlapping axis, so add in buffer to data domain
  xScale.domain([0, 0.7]);
  yScale.domain([0.25, 0.9]);

  // x-axis
  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
    .append("text")
      .attr("class", "label")
      .attr("x", width)
      .attr("y", -6)
      .style("text-anchor", "end")
      .text("% Voting Republican in Presidential Election");
  // y-axis
  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("class", "label")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("% Yes for Marijuana Legalization");

  // draw dots
  
  svg.selectAll(".dot")
      .data(data)
    .enter().append("circle")
      .attr("class", "dot")
      .attr("r", 3.5)
      .attr("cx", xMap)
      .attr("cy", yMap)
      .style("fill", function(d) { return color(cValue(d));}) 
      .on("mouseover", function(d) {
          tooltip.transition()
               .duration(200)
               .style("opacity", 1.0);
          tooltip.html(d.Town + "<br/> (" + Math.round(xValue(d)*100)/100 
	        + "," + Math.round(yValue(d)*100)/100 + ")")
               .style("left", (d3.event.pageX + 5) + "px")
               .style("top", (d3.event.pageY - 28) + "px");
      })
      .on("mouseout", function(d) {
          tooltip.transition()
               .duration(500)
               .style("opacity", 0);
      });
  
  // draw legend



});
}
</script>

<p>
	
</p>

<p>Going through a number of different variables, I found the best predictor of voting yes was a variable I named "Bernie Popularity"; the product of Bernie Sanders vote. The outliers to the upper left of the main fit are either non-white or rich Boston area districts that were socially liberal but didn't like Bernie much. The red dot to that score high in Bernie Popularity but not that very high for marijuana legalization are liberal rural Western Massachusetts areas with lots of older voters. The very upper right are college areas (Amherst & Northampton, Boston near BU & Northeastern, parts of Cambridge / Somerville). I colored the map as there was a clear racial pattern that was independent of partisanship</p>

<img src="bernie_legalweed.png" width="500">

<p>I also made a </a> <a href="weedvote_map.html"> zoomable map </a>  of the ballot results, placed it a separate page as it is rather large</p>